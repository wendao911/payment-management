# 应付管理系统重构说明

## 概述

本次重构将原有的"付款管理"功能升级为更完善的"应付管理"系统，增加了重要程度、紧急程度、币种、附件管理等功能，并引入了付款记录子表来更好地跟踪付款情况。

## 主要变更

### 1. 数据库结构重构

#### 表名变更
- `Payments` → `PayableManagement` (应付管理主表)
- 新增 `PaymentRecords` (付款记录子表)
- 新增 `Currencies` (币种表)
- 重构 `Attachments` (附件表)

#### 新增字段
- **重要程度** (`Importance`): 一般、重要、非常重要
- **紧急程度** (`Urgency`): 一般、紧急、非常紧急、已延期
- **币种** (`CurrencyCode`): 支持多币种
- **应付编号** (`PayableNumber`): 唯一标识符
- **备注** (`Description`): 详细说明

### 2. 功能增强

#### 应付管理主表
- 绑定合同ID和供应商ID
- 支持重要程度和紧急程度分类
- 多币种支持
- 多附件上传
- 自动状态管理（待付款、部分付款、已完成、逾期）

#### 付款记录子表
- 记录每次付款的详细信息
- 支持付款凭证附件
- 自动更新主表状态
- 防止超额付款

#### 附件管理
- 支持多种文件类型
- 关联到应付管理或付款记录
- 文件元数据管理

### 3. API接口更新

#### 应付管理接口 (`/api/payment`)
- `GET /` - 获取应付管理列表（支持搜索和分页）
- `GET /:id` - 获取单个应付管理详情（包含付款记录和附件）
- `POST /` - 创建应付管理记录
- `PUT /:id` - 更新应付管理记录
- `DELETE /:id` - 删除应付管理记录
- `POST /:id/attachments` - 上传附件
- `GET /currencies/list` - 获取币种列表
- `GET /stats/summary` - 获取统计信息
- `GET /overdue/list` - 获取逾期列表

#### 付款记录接口 (`/api/payment-records`)
- `GET /` - 获取付款记录列表（支持搜索和分页）
- `GET /payable/:payableId` - 获取指定应付管理的付款记录
- `POST /` - 创建付款记录
- `PUT /:id` - 更新付款记录
- `DELETE /:id` - 删除付款记录
- `POST /:id/attachments` - 上传付款凭证附件
- `GET /stats/summary` - 获取付款记录统计

### 4. 前端界面更新

#### 应付管理页面 (`/payments`)
- 新增重要程度、紧急程度、币种等字段显示
- 详情模态框，包含三个标签页：
  - 基本信息
  - 付款记录
  - 附件管理
- 支持多附件上传
- 实时统计信息显示

#### 付款记录页面 (`/payment-records`)
- 独立的付款记录管理界面
- 支持按应付管理、币种、日期范围搜索
- 统计卡片显示关键指标
- 完整的CRUD操作

#### 导航结构
- 应付管理菜单下包含两个子菜单：
  - 应付管理 (`/payments`)
  - 付款记录 (`/payment-records`)

## 技术特性

### 后端
- Node.js + Express
- MySQL数据库
- JWT认证
- 文件上传支持
- 数据验证
- 事务处理

### 前端
- React + Ant Design
- 响应式设计
- 状态管理
- 路由管理
- 表单验证

### 安全特性
- JWT令牌认证
- 请求频率限制
- 文件类型验证
- SQL注入防护
- CORS配置

## 使用说明

### 1. 创建应付管理记录
1. 在应付管理页面点击"新增应付管理"
2. 选择合同和供应商
3. 填写应付金额、币种、截止日期等信息
4. 设置重要程度和紧急程度
5. 添加备注和附件
6. 保存记录

### 2. 记录付款
1. 在应付管理详情页的"付款记录"标签页中点击"新增付款记录"
2. 或在付款记录页面直接创建
3. 选择对应的应付管理记录
4. 填写付款金额、说明、日期等信息
5. 上传付款凭证附件
6. 保存记录

### 3. 查看统计信息
- 仪表板显示总体统计
- 应付管理页面显示应付相关统计
- 付款记录页面显示付款相关统计

## 注意事项

1. **数据完整性**: 删除应付管理记录前会检查是否有关联的付款记录或附件
2. **状态同步**: 付款记录的增删改会自动更新应付管理的状态
3. **金额控制**: 付款金额不能超过剩余应付金额
4. **附件管理**: 支持多种文件格式，建议上传PDF、图片等常用格式
5. **权限控制**: 所有操作都需要有效的JWT令牌

## 部署说明

### 环境要求
- Node.js 14+
- MySQL 8.0+
- 现代浏览器支持

### 安装步骤
1. 克隆代码库
2. 安装依赖：`npm install`
3. 配置数据库连接
4. 运行数据库迁移脚本
5. 启动后端服务：`npm start`
6. 启动前端服务：`npm start`

### 环境变量
- `DB_HOST`: 数据库主机
- `DB_USER`: 数据库用户名
- `DB_PASSWORD`: 数据库密码
- `DB_NAME`: 数据库名称
- `JWT_SECRET`: JWT密钥
- `PORT`: 服务端口

## 版本历史

- **v1.0.0**: 初始版本，基础付款管理功能
- **v2.0.0**: 重构版本，升级为应付管理系统
  - 新增重要程度和紧急程度
  - 新增币种支持
  - 新增附件管理
  - 新增付款记录子表
  - 优化用户界面和用户体验

## 联系方式

如有问题或建议，请联系开发团队。
